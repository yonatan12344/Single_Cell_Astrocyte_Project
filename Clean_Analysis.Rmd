library loading
```{r}
install.packages("scCATCH")
library(Seurat)
library(tidyverse)
library(scCATCH)
```


loading in the data

```{r}
data = read.delim('/Users/yonatan/Desktop/Single_Cell_Proj/AQP4_snRNA_project/AQP4_Expression_snRNA_seq/Data/GSE143758_Admouse_Hippocampus_7m_AllNuclei_UMIcounts.txt', sep = '\t')
counts <- CreateSeuratObject(data)
```

Saving the Seurat object and allowing it to be loaded again the future for easy access
```{r}
SaveSeuratRds(counts,
              file= "initial_raw_count_matrix.rds")
counts <- LoadSeuratRds("initial_raw_count_matrix.rds")
```

Adding in the mitochondrial read percentages to each cell

```{r}
counts[["percent.mt"]] <- PercentageFeatureSet(counts, pattern = '^mt-')
unique(counts@meta.data$orig.ident)
NP40_Batch <- counts@meta.data %>% filter(orig.ident == 'NP40.Batch1')
# Visualize QC metrics as a violin plot
batch_1 <- VlnPlot(counts, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), idents = 'NP40.Batch1', ncol = 3, pt.size=0)
batch_2 <- VlnPlot(counts, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), idents = 'EZ.Batch1', ncol = 3, pt.size=0)
batch_3 <- VlnPlot(counts, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), idents = 'NP40.Batch3', ncol = 3, pt.size=0)
batch_1
batch_2
batch_3

plot1 <- FeatureScatter(counts, feature1 = "nCount_RNA", feature2 = "percent.mt", group.by = 'orig.ident', split.by = 'orig.ident', pt.size=0)
plot1
plot2 <- FeatureScatter(counts, feature1 = "nFeature_RNA", feature2 = "nCount_RNA", group.by = 'orig.ident', split.by = 'orig.ident')
plot2
```
Subsetting the 3 batches based on their unique distributions of data, and then I will rejoin them

```{r}
#Subsetting seurat object into multiple parts so I can do batch specific QC for each, 
# and then merge them again.
?subset()
counts_1 <- subset(counts, idents = 'NP40.Batch1')
counts_2 <- subset(counts,  idents = 'EZ.Batch1')
counts_3 <- subset(counts, idents = 'NP40.Batch3')

```
QC metrics for each batch
```{r}
counts_1 <- subset(counts_1, subset = nFeature_RNA > 200 & percent.mt < 5)
counts_2 <- subset(counts_2, subset = nFeature_RNA > 200 & nFeature_RNA < 2800 & percent.mt < 5)
counts_3 <- subset(counts_3, subset = nFeature_RNA > 200 & nFeature_RNA < 2800 & percent.mt < 5)
```

Remerging the seurat object

```{r}
counts <- merge(x = counts_1, y = list(counts_2, counts_3))
```

Im going to try using sctransform here, not sure if its better compared to the find variable features, scale date, and normalize data approach tho

```{r}
counts <- SCTransform(counts)
counts <- RunPCA(counts, verbose = FALSE)
#documentation says pushing the PC components is something they found workis better
ElbowPlot(counts)
counts <- RunUMAP(counts, dims = 1:30, verbose = FALSE)
counts <- FindNeighbors(counts, dims = 1:30, verbose = FALSE)
counts <- FindClusters(counts, verbose = FALSE)
DimPlot(counts, label = TRUE, group.by='orig.ident') + labs(title="Batch Effects UMAP")
```
identifying batch effects in umap plot
```{r}
DimPlot(counts, label = TRUE) + labs(title="Unannotated Cell types?")
DimPlot(counts, label = FALSE, group.by='orig.ident') + labs(title="Batch Effects UMAP")
```
Conclusion the batch effects don't seem to be too strong in the data, I am going to ignore them. Time to identify the astrocyte cluster based on cell markers


```{r}
FeaturePlot(counts, features = c("GFAP", "EAAT1", "GLAST", "EAAT2", "GLT-1"))
```


Saving the Seurat object and allowing it to be loaded again the future for easy access
```{r}
SaveSeuratRds(counts,
              file= "UMAP_PCA_SCT_transform.rds")
counts <- LoadSeuratRds("UMAP_PCA_SCT_transform.rds")
?FindAllMarkers
```


```{r}
# Error message told me to run this before running FindAllMarkers
counts <- PrepSCTFindMarkers(counts)
counts.markers <- FindAllMarkers(counts, only.pos = FALSE)
counts.markers %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1)
x <- counts@meta.data$seurat_clusters
?findcelltype
```


# using scCATCH to identify cell types for me (probably suboptimal lowkey but im kinda of tired)

```{r}
FeaturePlot(counts, features = c("Slc1a3", "Gfap", "Aldoc", "Glul", "Rarres2", "Slc6a13", "Aqp4"))

FeaturePlot(counts, features = c("Slc1a3", "Gfap"))
```
Might be reaching here but I think its safe to assume clusters 1 and 7 are astrocytes.


Exporting into an Astrocyte_specific file based on clusters 1 and 7
```{r}
counts@meta.data
seven_month_all_nuclei_astrocytes <- subset(counts, idents list(1, 7))
```

