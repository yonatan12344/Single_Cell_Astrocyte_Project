A better dataset?
I am using GSE143758, a mouse snRNA seq study with several samples, comparing
AD to WT mice. I am going to look at astrocytes and see if the data is high quality.

Loading in needed packages
```{r}
library(Seurat)
library(tidyverse)
library(readr)
```

Loading in the data into a csv so it can be turned into a seurat object
```{r}
data <- read.delim("/Users/yonatan/Desktop/single_cell_AD_WT_mice_data/GSE143758_Admouse_Crtx_7-10m_Astrocytes_UMIcounts.csv", sep = ';', row.names = 1)
```
turning the data into a seurat object
```{r}
ad_wt_astro <- CreateSeuratObject(data)
```
Adding in the percent of counts that map to mitochondrial DNA in the seurat object's meta data 
```{r}
ad_wt_astro[["percent.mt"]] <- PercentageFeatureSet(ad_wt_astro, pattern = "^mt-")
```
Generating key QC plots to help determine appropriate cutoff values for the gene count of cells, as well as the total number of couts for genes. These is to filter low quality cells, cells that are dying or low quality often have a lot of mitochondrial, and snRNA seq in theory should have no mitchondrial contamination.
```{r}
# Visualize QC metrics as a violin plot
VlnPlot(ad_wt_astro, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)
?VlnPlot
?CreateSeuratObject
metadata <- ad_wt_astro@meta.data
metadata
x <- rownames(ad_wt_astro)


# Paper used a filtering metric of > 400 detected genes, 
# I will manually calculate the outlier values for the Feature RNA,
# and use a value between 3 - 5 outliers for the nCount_RNA and n_Feature_RNA
# It is possible I am removing biological signal, but I will 
```

Adaptive Thresholds for my data. Based of the informations here, https://bioconductor.org/books/3.12/OSCA/quality-control.html?utm_source=chatgpt.com . Essentially operating under the assumption most of the nuclei here are off high quality, I can set thresholds based on outliers (using median for this) I will "calculate the median absolutiate deviation, from the median value of each metric across the cells" (word for word from the website) for the 3 features above.

For this moment though I am a bit lazy so I will base QC metrics, off of visually determined cutoffs, and integrate the outlier detection process later, since the work required to do so is extensive, and requires extra packages. The visual below will further help determine cutoffs.

```{r}
plot1 <- FeatureScatter(ad_wt_astro, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(ad_wt_astro, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2
```

Based of the visuals from earlier we want to get reid of these outliers, cutoffs of 5 percent for the mitochondrial percentage,
2500 for the total number of counted UMI's and 1500 for the number of expressed genes would be reasonable. I also want to set a minimum for the nFeature RNA of 200 for now.

```{r}
ad_wt_astro <- subset(ad_wt_astro, subset = nFeature_RNA > 200 & nFeature_RNA < 1500 & percent.mt < 5)
```

I used normalizeData, but scTransform is lowkey

```{r}
ad_wt_astro <- NormalizeData(ad_wt_astro, normalization.method = "LogNormalize", scale.factor = 10000)
```
I dont have a high count of genes, and am moreso interested in what astrocytes are doing as a group rather than as indvidual cells, so a pseudobulk approach is better. A key important thing for me is to get good metadata columns that contain information on the age of these male mice and whether they have AD or not. 
```{r}
rownames(metadata)
```
cell_names <- colnames(AD_CT_Astrocytes)
# 2. Split each barcode by the underscore and keep the LAST element
# This separates the UMI from the Sample ID.
```{r}
cell_names_and_con <- rownames(metadata)
cell_names_and_con separate_wider_position()
ad_wt_astro@meta.data %>% separate_wider_position(rownames(metadata), c(gender = 1, 1, unit = 3))
```

